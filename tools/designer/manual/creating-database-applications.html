<HTML
><HEAD
><TITLE
>Creating Database Applications</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.57"><LINK
REL="HOME"
HREF="book1.html"><LINK
REL="PREVIOUS"
TITLE="Creating Custom Widgets with Plugins "
HREF="creatingcustomwidgetswithplugins.html"><LINK
REL="NEXT"
TITLE="Using 
QDataTable"
HREF="using-qdatatable.html"></HEAD
><BODY
CLASS="CHAPTER"
><DIV
CLASS="NAVHEADER"
><TABLE
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
></TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="creatingcustomwidgetswithplugins.html"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="using-qdatatable.html"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="CHAPTER"
><H1
><A
NAME="CREATING-DATABASE-APPLICATIONS"
>Chapter 6. Creating Database Applications</A
></H1
><DIV
CLASS="TOC"
><DL
><DT
><B
>Table of Contents</B
></DT
><DT
><A
HREF="creating-database-applications.html#SETTING-UP-DATABASE-CONNECTIONS"
>Setting Up Database Connections</A
></DT
><DT
><A
HREF="using-qdatatable.html"
>Using 
<TT
CLASS="CLASSNAME"
>QDataTable</TT
></A
></DT
><DT
><A
HREF="using-qdatabrowser-and-qdataview.html"
>Using 
<TT
CLASS="CLASSNAME"
>QDataBrowser</TT
> and 
<TT
CLASS="CLASSNAME"
>QDataView</TT
></A
></DT
></DL
></DIV
><P
>&#13;


This chapter shows you how to use Qt's data-aware widgets from within
<I
CLASS="EMPHASIS"
>Qt Designer</I
>. It demonstrates <TT
CLASS="LITERAL"
>INSERT</TT
>, <TT
CLASS="LITERAL"
>UPDATE</TT
> and <TT
CLASS="LITERAL"
>DELETE</TT
> in both 
<TT
CLASS="CLASSNAME"
>QDataTable</TT
>s
(tables) and 
<TT
CLASS="CLASSNAME"
>QDataBrowser</TT
>s (forms). It also shows how to code
Master-Detail relationships and Drilldown. A simple approach to foreign
key handling is presented here; a more sophisticated approach is shown
in the online SQL module documentation.</P
><P
>&#13;




















If you wish to run the examples or create your own applications using
these widgets you need access to an SQL database and a Qt database driver
that can connect to the database. At the time of writing the drivers
that Qt supports are QODBC3 (Open Database Connectivity), QOCI8 (Oracle),
QPSQL7 (PostgreSQL 6 and 7) and QMYSQL3 (MySQL).</P
><P
>&#13;




Although you can use the Qt data-aware widgets to browse and edit data
in SQL databases without having to write any SQL, a basic understanding
of SQL is highly recommended. We assume that you have some familiarity with
<TT
CLASS="LITERAL"
>SELECT</TT
>, <TT
CLASS="LITERAL"
>INSERT</TT
>, <TT
CLASS="LITERAL"
>UPDATE</TT
> and <TT
CLASS="LITERAL"
>DELETE</TT
> statements. We also assume a basic
understanding of the concepts of normalisation and of primary and
foreign keys. A standard text covering SQL databases is <I
CLASS="CITETITLE"
>An Introduction to Database Systems (7th ed.)</I
> by C. J.
Date, ISBN 0201385902.</P
><P
>&#13;


In the following text we describe the creation of a 'book' database
application. The application demonstrates how to use

<TT
CLASS="CLASSNAME"
>QDataTable</TT
>s including in-place record editing and how to set
up master-detail relationships between 
<TT
CLASS="CLASSNAME"
>QDataTable</TT
>s. It also
explains how to drill down from a 
<TT
CLASS="CLASSNAME"
>QDataTable</TT
> to another
widget, for example, to a 
<TT
CLASS="CLASSNAME"
>QDataBrowser</TT
> or a 
<TT
CLASS="CLASSNAME"
>QDataView</TT
>
and how to perform record editing in a 
<TT
CLASS="CLASSNAME"
>QDataBrowser</TT
>. A great
deal of functionality is available from the classes directly in <I
CLASS="EMPHASIS"
>Qt Designer</I
>
although subclassing is always available for finer control. If you
want to build the 'book' examples you will need to create the example
schema on your database.  <DIV
CLASS="FIGURE"
><A
NAME="AEN4441"
></A
><P
><B
>Figure 6-1. The Book Application</B
></P
><P
><IMG
SRC="images\book-main.png"></P
></DIV
></P
><TABLE
CLASS="SIDEBAR"
BORDER="1"
CELLPADDING="5"
><TR
><TD
><DIV
CLASS="SIDEBAR"
><A
NAME="AEN4444"
></A
><P
><B
>The Example Schema</B
></P
><P
>Note that the examples in this chapter all use the tables, views and
records which are defined in the
<TT
CLASS="FILENAME"
>qt/tools/designer/examples/book/book.sql</TT
> file. This file has
been tested with PostgreSQL 6 and PostgreSQL 7. You may need to modify
the SQL in this file to recreate the example database on your own
system.

<DIV
CLASS="EXAMPLE"
><A
NAME="AEN4448"
></A
><P
><B
>Example 6-1. Schema <TT
CLASS="LITERAL"
>CREATE TABLE</TT
> Statements</B
></P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="PROGRAMLISTING"
>CREATE TABLE author 
( id integer, 
forename varchar(40), 
surname varchar(40) );
CREATE TABLE book 
( id integer, 
title varchar(40), 
price numeric(10,2), 
authorid integer, 
notes varchar(255) );
CREATE TABLE sequence
( tablename varchar(10),
sequence numeric);</PRE
></TD
></TR
></TABLE
></DIV
>

The 'book' table is simplified for the purposes of the example. It can
only relate a book to a single author (authorid) and lacks an ISBN
field.  The 'sequence' table is used for generating unique index
values for the example tables.  Note that SQL databases often provide
their own method for creating sequences (for example, using the
<TT
CLASS="LITERAL"
>CREATE SEQUENCE</TT
> command) which is very likely to be a more
optimal solution. For the sake of portability the examples will use a
'sequence' table which will work with the vast majority of SQL
databases.</P
></DIV
></TD
></TR
></TABLE
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="SETTING-UP-DATABASE-CONNECTIONS"
>Setting Up Database Connections</A
></H1
><P
>    

    

    There are two aspects of database connections that we must consider.
    Firstly the connection we wish to use within <I
CLASS="EMPHASIS"
>Qt Designer</I
> itself, and
    secondly the connection we wish to use in the applications that we
    create.
    </P
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="SETTING-UP-QT-DESIGNERS-CONNECTIONS"
>Setting Up <I
CLASS="EMPHASIS"
>Qt Designer</I
>'s Connections</A
></H2
><P
>	<DIV
CLASS="FIGURE"
><A
NAME="AEN4467"
></A
><P
><B
>Figure 6-2. Database Connections Dialog</B
></P
><P
><IMG
SRC="images\database-connections.png"></P
></DIV
>
	Choose 
<SPAN
CLASS="GUIMENUITEM"
>Edit|Database Connections</SPAN
> from the menu
	bar. The 
Database Connections dialog will appear. Click
	<SPAN
CLASS="GUIBUTTON"
>New Connection</SPAN
>. For applications that use a single
	database it will probably be most convenient to use the default
	connection name of '(default)'. If you use more than one
	database then each one must be given a unique name. A driver must be
	chosen from the Driver combo box. The database name may be
	available in the Database Name combo box or may have to be typed
	in. The database name, username, password and hostname should be
	provided by your database system administrator. When the
	Connection information has been completed click
	<SPAN
CLASS="GUIBUTTON"
>Connect</SPAN
>. If the connection is made the connection
	name will appear in the list box on the left hand side of the
	dialog. You can now close the dialog; the connection settings
	will remain in effect until you change or delete them or exit
	from <I
CLASS="EMPHASIS"
>Qt Designer</I
>.
	</P
><P
>	

	<I
CLASS="EMPHASIS"
>Qt Designer</I
> can remember database connection settings in
	<B
CLASS="COMMAND"
>qmake</B
> project files. Create a new project, e.g.
	click 
<SPAN
CLASS="GUIMENUITEM"
>File|New Project</SPAN
> and complete the 
	
Project Settings dialog. 
	 Next time you start <I
CLASS="EMPHASIS"
>Qt Designer</I
> instead of
	opening individual <TT
CLASS="LITERAL"
>.ui</TT
> files open the
	<TT
CLASS="LITERAL"
>.pro</TT
> project file instead and <I
CLASS="EMPHASIS"
>Qt Designer</I
> will
	automatically reload the project's connection settings.  To
	activate the connection click 
<SPAN
CLASS="GUIMENUITEM"
>Edit|Database Connections</SPAN
>. 
	The connections previously saved with the
	project will be listed in the left hand list box. Click the
	connection you wish to use and then click <SPAN
CLASS="GUIBUTTON"
>Connect</SPAN
>. This
	connection will be used from now on, e.g. for previewing
	
<TT
CLASS="CLASSNAME"
>QDataTable</TT
>s. Opening a project file also causes <I
CLASS="EMPHASIS"
>Qt Designer</I
> to
	load in the list of forms associated with the project into the
	Form List window. In most of the explanation that follows we
	will assume that you use project files and have clicked
	<SPAN
CLASS="GUIBUTTON"
>Connect</SPAN
> so that there is always a connection available
	when you work in
	<I
CLASS="EMPHASIS"
>Qt Designer</I
>.
	</P
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="SETTING-UP-CONNECTIONS-FOR-APPLICATIONS"
>Setting Up Connections for Applications</A
></H2
><P
>	The applications you create must make their own connections to
	the SQL database.
<DIV
CLASS="EXAMPLE"
><A
NAME="AEN4511"
></A
><P
><B
>Example 6-2. 
<TT
CLASS="FUNCTION"
>createConnections()</TT
> function</B
></P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="PROGRAMLISTING"
>bool createConnections()
{
    // create the default database connection
    <I
CLASS="EMPHASIS"
>QSqlDatabase</I
> *defaultDB = <I
CLASS="EMPHASIS"
>QSqlDatabase::addDatabase</I
>( &quot;QPSQL6&quot; );
    if ( ! defaultDB ) {
        qWarning( "Failed to connect to driver" );
        return FALSE;
    }
    defaultDB-&gt;setDatabaseName( &quot;book&quot; );
    defaultDB-&gt;setUserName( &quot;bookuser&quot; );
    defaultDB-&gt;setPassword( &quot;bookpw&quot; );
    defaultDB-&gt;setHostName( &quot;bookhost&quot; );
    if ( ! defaultDB-&gt;open() ) {
        qWarning( &quot;Failed to open books database: &quot; +
                  defaultDB-&gt;lastError().driverText() );
        qWarning( defaultDB-&gt;lastError().databaseText() );
        return FALSE;
    }

    return TRUE;
}</PRE
></TD
></TR
></TABLE
></DIV
>
	We call 
<TT
CLASS="FUNCTION"
>addDatabase()</TT
> passing it the name of the
	driver we wish to use. We then set the connection information by
	calling the <TT
CLASS="LITERAL"
>set...</TT
> functions. Finally we attempt to
	open the connection. If we succeed we return TRUE, otherwise we
	output some error information and return FALSE.
<DIV
CLASS="EXAMPLE"
><A
NAME="AEN4525"
></A
><P
><B
>Example 6-3. From <TT
CLASS="FILENAME"
>qt/tools/designer/examples/book/book1/main.cpp</TT
></B
></P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="PROGRAMLISTING"
>int main( int argc, char *argv[] ) 
{
    <I
CLASS="EMPHASIS"
>QApplication</I
> app( argc, argv );

    if ( ! createConnections() ) 
        return 1;

    BookForm bookForm;
    app.setMainWidget( &amp;bookForm );
    bookForm.show();

    return app.exec();
}</PRE
></TD
></TR
></TABLE
></DIV
>
	

	All the examples presented in this chapter call
	
<TT
CLASS="FUNCTION"
>createConnections()</TT
> after creating the
	
<TT
CLASS="CLASSNAME"
>QApplication</TT
> object in their 
<TT
CLASS="FILENAME"
>main.cpp</TT
>
	file and make use of the default connection. If you need to
	connect to multiple databases use the two-argument form of
	
<TT
CLASS="FUNCTION"
>addDatabase()</TT
>, passing it both the name of the driver
	and a unique identifier. This is explained further in the <A
HREF="http://doc.trolltech.com/sql.html"
TARGET="_top"
>Qt SQL Module
	documentation</A
>.
	</P
><P
>	Note that you do not need to keep a reference to database
	connections. If you use a single database connection, this
	becomes the default connection and database functions will use
	this connection automatically. We can always get a pointer to
	any of our connections by calling
	
<TT
CLASS="FUNCTION"
>QSqlDatabase::database()</TT
>.
	</P
></DIV
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="creatingcustomwidgetswithplugins.html"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="book1.html"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="using-qdatatable.html"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Creating Custom Widgets with Plugins</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Using 
<TT
CLASS="CLASSNAME"
>QDataTable</TT
></TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
