#!/usr/bin/perl -w

# $Id: //depot/qt/main/util/scripts/make-public-thing#50 $

$snapshotversion=200;
$base = "/tmp/striptree-$$";
$days_stored = 60;
$verbose=0;
$skipdoc=0;
$dryrun=0;

use File::Find;

sub copyandstrip {
    #
    #  Copy $dir/$_ (.../qt/...) to $base/cvs/qt/... while removing
    #  all branches and any revisions older than $date (unless that
    #  would leave no head).  Also creates directories.
    #
    if ( $_ ne "." && $_ ne ".." ) {
	my $dir = $File::Find::dir;
	$dir =~ s-/?$-/-;
	$dir =~ s-^.*/qt/-$base/cvs/qt/-;
	if ( -d $_ ) {
	    mkdir("$dir$_", 0755);
	} elsif ( /,v$/ && -d $dir && open( I, "< $_" ) ) {
	    my $f;
	    my $v;
	    $f = join( "", <I> );
	    $v = $f;
	    $v =~ s/\nsymbols[^;]*/\nsymbols/s;

	    #
	    # Copy the file
	    #
	    close(I);
	    open( O, "> $dir$_" ) || die "could not open $dir$_, stopped";
	    print O $v;
	    close O;
	    chmod( (stat $_)[2], "$dir$_" );
	    $v = $f;

	    #
	    # Outdate all branches
	    #
	    ($revs) = $f =~ /.*?;\s*\nlocks(.*?)\nlog.*$/s;
	    while ( $revs =~ /\nbranches\s*((?:\d+\.)+\d\.\d)[;\n]/g ) {
		$branch=$1;
		print "Stripping branch ${branch} from $dir$_\n" if $verbose == 1;
		if ( $verbose <= 1 ) {
		    print SH "rcs -q -o${branch}: $dir$_\n";
		} else {
		    print SH "echo rcs -o${branch}: $dir$_\n";
		    print SH "rcs -o${branch}: $dir$_\n";
		}
	    }

	    #
	    # Outdate almost everything before $date (except the head (!))
	    #
	    $v =~ s/.*?head\s*(.*?);.*?\ncomment[^\n]*\n\s*//s;
	    $v =~ s/\n\ndesc\n.*$//s;
	    $v =~ s/\ndate\s+(\d+)\.(\d+)\.(\d+)\..*?(?:$|(?:\n\n))/ $1$2$3\n/gs;
	    $fd = undef;
	    $ld = undef;
	    foreach $f ( split( /\n/, $v ) ) {
		if ( !( $f =~ /^(\d+\.\d+)\s+(\d+)$/ ) ) {
		    # it's a branch.  ignore it.
		} elsif ( $2 > $date ) {
		    # keep that one.
		} elsif ( !defined( $ld ) ) {
		    # the latest revision before the cutoff date
		    # we'll keep it, but the next one goes.
		    $ld = "magic";
		} elsif ( $ld eq "magic" ) {
		    # last deleted revision
		    $ld = $1;
		    $fd = $1;
		} else {
		    # first deleted revision (afaik - we'll change it if we
		    # see another)
		    $fd = $1;
		}
	    }
	    if ( defined( $ld ) && defined( $fd ) ) {
		print "Stripping $fd to $ld from $dir$_\n" if $verbose == 1;
		if ( $verbose <= 1 ) {
		    print SH "rcs -q -o$fd:$ld $dir$_\n";
		} else {
		    print SH "echo rcs -o$fd:$ld $dir$_\n";
		    print SH "rcs -o$fd:$ld $dir$_\n";
		}
	    }
	}
    }
}

# Maybe we should check out tmake?
#
die '$TMAKEDIR not set - need $TMAKEDIR/lib/linux-g++/tmake.conf'
    if !defined($ENV{TMAKEDIR})
	|| ! -f "$ENV{TMAKEDIR}/lib/linux-g++/tmake.conf";

($junk, $junk, $junk, $d, $m, $y, $junk, $junk, $junk) =
  localtime( time() - $days_stored * 86400 );
$date = sprintf( "%4d%02d%02d", $y, 1+$m, $d ); ##### Y2K - what does CVS do?

mkdir( $base, 0755 );
mkdir( "$base/cvs", 0755 );
mkdir( "$base/cvs/qt", 0755 );
mkdir( "$base/cvs/qt/html", 0755 );
mkdir( "$base/cvs/CVSROOT", 0755 );

open( SH, "| /bin/zsh" );

find( \&copyandstrip, "/local/lib/cvs/qt" );

print SH "cd $base/cvs/qt

# Move-around CVS files to be like regular release
mv dist/free/LICENSE.QPL,v .

# Remove GMAKE and NMAKE makefiles
find . -name GNUmakefile,v | xargs rm
find . -name Makefile,v | xargs rm
rm GNUmakefile.inc,v
rm Makefile.inc,v
rm make.help,v

# Check-out current public CVS
mkdir $base/head
cd $base/head
cvs -Q -d $base/cvs co qt
mkdir -p qt/doc/html
cd qt
cp gif/*.gif doc/html
cd include
ln -s ../src/*/q*.h .
cd ../src/moc
yacc -d moc.y
mv y.tab.c mocgen.cpp
cd ../..

# Package Windows-only source files separately
# REMAINING ISSUES: Borland vs. MSVC++ makefiles
WINFILES='src/Makefile.win32-dll '`find src -name '*_win*'; find include -name '*_win*'`
rm -f \$WINZIP
WINZIP=/local/qt/dist/qtwin$snapshotversion-`date +%Y%m%d`-snapshot.zip
rm -f
zip -9 \$WINZIP \$WINFILES
rm \$WINFILES
rm -rf $base/cvs/qt/*/*/*_win*

# THERE SHOULD BE NO WINDOWS STUFF AFTER THIS POINT

export QTDIR=$base/head/qt
export PATH=\$QTDIR/bin:\$QTDIR/util/scripts:\$PATH:/home/agulbra/bin

# Generate and check-in [changes to] the X11 makefiles/build files

cd $base/head/qt
for B in src/moc/mocgen.cpp `util/scripts/makeunixmake -p -s`
do
  perl -pi -e 's/Generated by tmake at.*/Generated by tmake/' \$B
  C=$base/cvs/qt/\$B,v
  rsync -avz motorkatt:/local/lib/cvs/qt/\$B,v \$C
  [ -f \$C ] && rcs -l \$C
  ci -q -mnone -t-'' -u \$B \$C
done
";

# Generate and check-in [changes to] the documentation
if ( $skipdoc ) {
    # Doesn't work.  Don't know why not.
    $skipdocexcl = "--exclude /local/lib/cvs/qt/html";
} else {
    $skipdocexcl = "";
    print SH "
    for a in tutorial/t{,1}[0-9]; do cp -f \$a/Makefile.in \$a/Makefile ; done
    perl util/qdoc/qdoc
    for a in tutorial/t{,1}?; do rm -f \$a/Makefile ; done
    cd doc/html
    mkdir -p $base/cvs/qt/html
    rsync -avz motorkatt:/local/lib/cvs/qt/html $base/cvs/qt
    for B in *.html *.gif *.jpg
    do
      C=$base/cvs/qt/html/\${B},v
      [ -f \$C ] && rcs -l \$C
      ci -q -mnone -t-'' -u \$B \$C
    done
    ";
}
print SH "mv $base/cvs/qt/gif/*.gif,v $base/cvs/qt/html\n";

print SH "
# Remove non-public files (mainly old CVS junk)
cd $base/cvs/qt
rm -rf bin/*.bat,v
rm -rf bugs dist doc.conf,v etc iconify listview mlined netscape nsplugin printpicture reqs tests util
rm -rf examples/dragdrop-tricky examples/layouts examples/network
rm -rf examples/tellme examples/xshape
rm -rf extensions/localizer
find extensions -print
rm -f extensions/*/doc.conf,v
rm -rf makefiles tmake
rm -f src/Makefile.win32-dll,v
rm -f src/*.pro,v
# Real source should be packaged and deleted by now, but
# this gets anything left in the Attic, etc.
find $base/cvs/qt -name '*_win*' | xargs rm -f
find $base/cvs/qt -name '*_os2*' | xargs rm -f
chmod a+x $base/cvs/qt/bin/*,v
find $base/cvs/qt -type d -print | xargs -r chmod 1777
";

if ( !$dryrun ) {
    print SH
	"rsync -av $skipdocexcl --delete $base/cvs/qt motorkatt:/local/lib/cvs\nrm -rf $base";
}

close(SH) # We want to wait for the script to complete.
