#!/usr/bin/perl

$version="1.30";                      # May include "beta", etc.
$winfile="qtwin130.zip";                 # Name as presented to customer
$winsource="~/qtwin130.zip";             # File on zen.linpro.no
$xfile="qt-1.30-commercial.tar.gz";      # Name as presented to customer
$xsource="~/qt-1.30-commercial.tar.gz";  # File on zen.linpro.no
$custfile = $ENV{"HOME"}."/troll/kunder.txt";
$dryrun=0; #"testrun";          # 0 for real, or file for test result


$message=			     # Footer of message
"Please send me mail when I can delete the files, and feel free to send
any questions to support\@troll.no.

- Paul";




open( CUSTOMERS, "<".$custfile ) || die "1";
open( SSH, "| ssh zen.linpro.no" ) || die "2";
print SSH "cd www/ftp/.private\n";

foreach $line ( <CUSTOMERS> ) {
    $exp = "";
    chomp $line;
    ($name, $addr, $platform, $exp, $org) = split( / *\t+ */, $line );
    die "$line\ninvalid line, stopped" unless ( $exp =~ m-^\d+/\d+/\d+$- );

    $key = lc $org;
    $key =~ s/[^a-z0-9].*//;
    $_ = `mcookie`;
    $_ =~ s/(........).*/\1/s;
    $key = "$key-$_";


    $to = $addr;
    if ($dryrun) {
        open( MAIL, ">> $dryrun" );
    } else {
        open( MAIL, "| /usr/sbin/sendmail -t" );
    }

    print MAIL  "To: ",$to,"\n",
		"Subject: Qt ",$version," released\n",
		"Organization: Troll Tech AS; fax +47 22646949; http://www.troll.no\n",
		"Cc: support\@troll.no\n",
		"Reply-To: support\@troll.no\n",
		"MIME-Version: 1.0\n",
		"Content-Type: text/plain; charset=US-ASCII\n",
		"\n" ;
    print MAIL
"Dear Qt customer, 

Qt version 1.31 is now released, it is a bug fix release tith the
following bugs fixed (compared to 1.30):

Changing the font of a QButton, QPushButton, QCheckBox or QRadioButton now
works correctly.

QRadiobutton:    Correct toggling in a QButtonGroup when activated by an
                 accelerator.

QPopupMenu:      Items updated correctly when activated by an accelerator.

QProgressBar:    Base color is no longer fixed to white.

QProgressDialog: setLabel() and setCancelButton() now ensure that a given
	         widget is shown and is a child of QProgressDialog.

QWidget:         setEnabled( FALSE ) now moves focus correctly.

QLineEdit and
QMultiLineEdit:  In keyPressEvent() backspace no longer inserts an
                 unprintable character with some rare keyboard layouts.

QMenubar:        Mouse presses on items without any popup menu are now
		 always recognized.

Changes to fix compile problems under IRIX.

Changes to fix compile problems on some versions of AIX.

Changes to fix compile problems with aCC on HP-UX.

Minor documentation fixes.
";


    print SSH "mkdir ", $key, "\n";


    if ( $platform =~ /w/ ) {
	print SSH "ln ",$winsource," ", $key, "\n";
	print MAIL "
Here is a URL for the Windows version:

   ftp://ftp.troll.no/.private/", $key, "/", $winfile, "
";
    }

    if ( $platform =~ /x/ ) {
	print SSH "ln ",$xsource," ", $key, "\n";
	print MAIL "
Here is a URL for the X11 version:

   ftp://ftp.troll.no/.private/", $key, "/", $xfile, "
";
    }


    print MAIL "
",$message,"
";
    close MAIL;
}

close SSH;




