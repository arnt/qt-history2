#!/usr/bin/perl

$version="1.3beta4";                      # May include "beta", etc.
$file="qtwin13beta4.zip";                 # Name as presented to customer
$source="~/qtwin13beta4.zip";             # File on zen.linpro.no
$custfile = $ENV{"HOME"}."/troll/kunder.txt";
$dryrun=0;
#"warwick\@troll.no";          # 0 for real, or email address of tester


$message=			     # Footer of message
"As always, feel free to send any questions to support\@troll.no.\n\n- Paul\n";

#
#"Please send me mail when I can delete the files, and feel free to send
#any questions to support\@troll.no.
#
#--".$ENV{"USER"};
#

open( CUSTOMERS, "<".$custfile ) || die "1";
open( SSH, "| ssh zen.linpro.no" ) || die "2";
print SSH "cd www/ftp/.beta\n";

foreach $line ( <CUSTOMERS> ) {
    $exp = "";
    chomp $line;
    ($name, $addr, $platform, $exp, $org) = split( / *\t+ */, $line );
    die "$line\ninvalid line, stopped" unless ( $exp =~ m-^\d+/\d+/\d+$- );

    next unless ( $platform =~ /w/ );

    $key = lc $org;
    $key =~ s/[^a-z0-9].*//;
    $_ = `mcookie`;
    $_ =~ s/(........).*/\1/s;
    $key = "$key-$_";


   $to = $dryrun ? $dryrun : $addr;
   #$to = "warwick\@troll.no";
    open( MAIL, "| /usr/sbin/sendmail -t" );
    print MAIL  "To: ",$to,"\n",
                "Subject: Qt 1.3 beta for Windows\n",
#		"Subject: Qt ",$version," released\n",
		"Organization: Troll Tech AS; fax +47 22646949; http://www.troll.no\n",
		"Cc: support\@troll.no\n",
		"Reply-To: support\@troll.no\n",
		"MIME-Version: 1.0\n",
		"Content-Type: text/plain; charset=US-ASCII\n",
		"\n" ;
    print MAIL
"Dear Qt customer, 

A new beta version of Qt 1.3 is now ready, and we are inviting you to
take part in beta-testing it. This will be the final beta, unless
major bugs are found.

Of course, we cannot guarantee that this beta version is suitable for
production work.

";

    print MAIL "
Qt ",$version," for Windows 95/NT is now ready to be downloaded
from the Troll Tech FTP site:

    ftp://ftp.troll.no/.beta/",$key,"/",$file,"

";

	if ( $platform =~ /x/ ) {
	    print MAIL
"As announced on the qt-beta mailing list, the current X beta is located at

    ftp://ftp.troll.no/.beta/allthetime/qt-1.3beta4.tar.gz

";
	}

    print SSH "mkdir ", $key, "\n";

    print SSH "ln ",$source," ", $key, "\n";

    print MAIL "
",$message,"
";
    close MAIL;
}

close SSH;
