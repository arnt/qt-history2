#!/usr/bin/perl

$version="1.3";                      # May include "beta", etc.
$file="qtwin13.zip";                 # Name as presented to customer
$source="~/qt/windows/qtwin13.zip";  # File on zen.linpro.no
$dryrun="warwick@troll.no";          # 0 for real, or email address of tester
$message=			     # Footer of message
"Please send me mail when I can delete the files, and feel free to send
any questions to support\@troll.no."

--",$USER;




open( CUSTOMERS, "< ~/troll/kunder.txt" ) || die "1";
open( SSH, "| ssh zen.linpro.no" ) || die "2";
print SSH "cd www/ftp/.private\n";

foreach $customer ( <CUSTOMERS> ) {
    $exp = "";
    chomp $line;
    ($name, $addr, $platform, $exp, $org) = split( / *\t+ */, $line );
    die "$line\ninvalid line, stopped" unless ( $exp =~ m-^\d+/\d+/\d+$- );

    next unless ( $platform =~ /w/ );

    $key = lc $org;
    $key =~ s/[^a-z0-9].*//;
    $_ = `mcookie`;
    $_ =~ s/(........).*/\1/s;
    $key = "$key-$_";


    $to = $dryrun ? $dryrun : $a;

    open( MAIL, "| /usr/sbin/sendmail -t" );
    print MAIL  "To: ",$to,"\n"
		"Subject: Qt ",$version," released\n",
		"Organization: Troll Tech AS; fax +47 22646949; http://www.troll.no\n",
		"Cc: support\@troll.no\n",
		"Reply-To: support\@troll.no\n",
		"MIME-Version: 1.0\n",
		"Content-Type: text/plain; charset=US-ASCII\n",
		"\n" ;

    print MAIL "
Qt ",$version," for Windows 95/NT is now ready to be downloaded
from the Troll Tech FTP site:

    ftp://ftp.troll.no/.private/",$key,"/",$file,"

";

    print SSH "mkdir ", $key, "\n";

    print SSH "ln ",$source," ", $key, "\n";

    print MAIL "
",$message,"
";
    close MAIL;
}

close SSH;
