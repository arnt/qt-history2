#!/bin/sh

XFREETYPE=yes
XCONFIG=$1/qmake.conf
VERBOSE=$2
SRCDIR=$3
OUTDIR=$4
shift 4
IN_LIBDIRS=""
IN_INCDIRS=""
PARAMS=$@
for PARAM in $PARAMS; do
    PREFIX=`echo $PARAM | sed 's/^\(..\).*/\1/'`
    case $PREFIX in
    -L)
	CLIBDIR=`echo $PARAM | sed -e 's/^-L//'`
	IN_LIBDIRS="$IN_LIBDIRS $CLIBDIR"
	;;
    -I)
        CINCDIR=`echo $PARAM | sed -e 's/^-I//'`
        IN_INCDIRS="$IN_INCDIRS $CINCDIR"
        ;;
    *) ;;
    esac 
done

# debuggery
[ "$VERBOSE" = "yes" ] && echo "XftFreeType auto-detection... ($*)"

# cleanup...
rm -f $OUTDIR/config.tests/x11/xfreetype.cfg
rm -f $OUTDIR/config.tests/x11/xfreetype.inc

# check for the XftFreeType library
XDIRS=`sed -n -e '/^QMAKE_LIBDIR_X11[	]*=/ { s/[^=]*=[	 ]*//; s/-L/ /g; p; }' $XCONFIG`
LIBDIRS="$IN_LIBDIRS $XDIRS /usr/shlib /usr/lib /lib"
F=
for LIBDIR in $LIBDIRS; do
    FOUND_LIB=`ls $LIBDIR/libXft.* 2>/dev/null`
    if [ ! -z "$FOUND_LIB" ]; then
	F=yes
	[ "$VERBOSE" = "yes" ] && echo "  Found XftFreeType lib in $LIBDIR"
	break
    fi
done
if [ -z "$F" ]; then
    XFREETYPE=no
    [ "$VERBOSE" = "yes" ] && echo "  Could not find XftFreeType lib anywhere in $LIBDIRS"
fi
    
# check for X11/Xft/Xft.h
XFT_H=
if [ "$XFREETYPE" = "yes" ]; then
    INC="X11/Xft/Xft.h"
    XDIRS=`sed -n -e '/^QMAKE_INCDIR_X11[	]*=/ { s/[^=]*=[	 ]*//; s/-I/ /g; p; }' $XCONFIG`
    INCDIRS="$IN_INCDIRS $XDIRS /usr/include /include"
    F=
    for INCDIR in $INCDIRS; do
	if [ -f $INCDIR/$INC ]; then
	    F=yes
	    XFT_H=$INCDIR/$INC
	    [ "$VERBOSE" = "yes" ] && echo "  Found $INC in $INCDIR"
	    break
	fi
    done
    if [ -z "$F" ]; then
	XFREETYPE=no
	[ "$VERBOSE" = "yes" ] && echo "  Could not find $INC anywhere in $INCDIRS"
    fi
fi

XFTCOMPAT_H=
if [ "$XFREETYPE" = "yes" ]; then
    INC="X11/Xft/XftCompat.h"
    XDIRS=`sed -n -e '/^QMAKE_INCDIR_X11[	]*=/ { s/[^=]*=[	 ]*//; s/-I/ /g; p; }' $XCONFIG`
    INCDIRS="$IN_INCDIRS $XDIRS /usr/include /include"
    for INCDIR in $INCDIRS; do
	if [ -f $INCDIR/$INC ]; then
	    XFTCOMPAT_H=$INCDIR/$INC
	    [ "$VERBOSE" = "yes" ] && echo "  Found $INC in $INCDIR"
	    break
	fi
    done
fi

if [ "$XFREETYPE" = "yes" ]; then
    INC="X11/Xft/XftFreetype.h"
    XDIRS=`sed -n -e '/^QMAKE_INCDIR_X11[	]*=/ { s/[^=]*=[	 ]*//; s/-I/ /g; p; }' $XCONFIG`
    INCDIRS="$IN_INCDIRS $XDIRS /usr/include /include"
    F=
    for INCDIR in $INCDIRS; do
	if [ -f $INCDIR/$INC ]; then
	    F=yes
	    [ "$VERBOSE" = "yes" ] && echo "  Found $INC in $INCDIR"
	    break
	fi
    done
    if [ -z "$F" ]; then
	XFREETYPE=no
	[ "$VERBOSE" = "yes" ] && echo "  Could not find $INC anywhere in $INCDIRS"
    fi
fi


# check for XftNameUnparse in X11/Xft/Xft.h
XFTNAMEUNPARSE=yes
if [ "$XFREETYPE" = "yes" ] && [ -f "$XFTCOMPAT_H" ]; then
    XFTNAMEUNPARSE=yes
else
    if [ "$XFREETYPE" = "yes" ] && [ -f "$XFT_H" ]; then
        grep XftNameUnparse $XFT_H >/dev/null || XFTNAMEUNPARSE=no
        [ "$XFTNAMEUNPARSE" = "no" ] && echo "xftnameunparse" > $OUTDIR/config.tests/x11/xfreetype.cfg
    fi
fi

# check for freetype2 headers
FREETYPE2_INCDIR=
if [ "$XFREETYPE" = "yes" ]; then
    INC="freetype2/freetype/freetype.h"
    XDIRS=`sed -n -e '/^QMAKE_INCDIR_X11[	]*=/ { s/[^=]*=[	 ]*//; s/-I/ /g; p; }' $XCONFIG`
    LDIRS=`sed -n -e '/^QMAKE_INCDIR[	]*=/ { s/[^=]*=[	 ]*//; s/-I/ /g; p; }' $XCONFIG`
    INCDIRS="$IN_INCDIRS $XDIRS $LDIRS /usr/include /include"
    F=
    for INCDIR in $INCDIRS; do
	if [ -f $INCDIR/$INC ]; then
	    F=yes
	    FREETYPE2_INCDIR=$INCDIR/freetype2
	    [ "$VERBOSE" = "yes" ] && echo "  Found $INC in $INCDIR"
	    break
	fi
    done
    if [ -z "$F" ]; then
	XFREETYPE=no
	[ "$VERBOSE" = "yes" ] && echo "  Could not find $INC anywhere in $INCDIRS"
    fi    
fi


# done
if [ "$XFREETYPE" != "yes" ]; then
    [ "$VERBOSE" = "yes" ] && echo "XftFreeType disabled."
    exit 0
else
    [ "$VERBOSE" = "yes" ] && echo "XftFreeType enabled."
    echo "$FREETYPE2_INCDIR" > $OUTDIR/config.tests/x11/xfreetype.inc
    exit 1
fi
