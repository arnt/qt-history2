#!/bin/sh


XKB=yes
XCONFIG=$1/qmake.conf
VERBOSE=$2


# debuggery

if [ "$VERBOSE" = "yes" ]
then
    echo "XKB auto-detection..."
fi
    

# check for headers

XKBLIB_H=
if [ "$XKB" = "yes" ]
then
    INC="X11/XKBlib.h"
    XDIRS=`sed -n -e '/^QMAKE_INCDIR_X11[	]*=/ { s/[^=]*=[	 ]*//; s/-I/ /g; p; }' $XCONFIG`
    INCDIRS="$XDIRS /usr/include /include"
    F=
    for INCDIR in $INCDIRS
    do
	if [ -f $INCDIR/$INC ]
	then
	    F=yes
	    XKBLIB_H=$INCDIR/$INC
	    if [ "$VERBOSE" = "yes" ]
	    then
		echo "  Found $INC in $INCDIR"
	    fi
	    break
	fi
    done
    if [ -z "$F" ]
    then
	XKB=no
	if [ "$VERBOSE" = "yes" ]
	then
	    echo "  Could not find $INC anywhere in $INCDIRS"
	fi
    fi
fi

# check for XkbSetPerClientControls in X11/XKBlib.h
# if it is not found, we disable xkb support

if [ "$XKB" = "yes" ] && [ -f "$XKBLIB_H" ]
then
    grep XkbSetPerClientControls $XKBLIB_H >/dev/null || XKB=no
    
    if [ "$VERBOSE" = "yes" ]
    then
	if [ "$XKB" = "yes" ]
	then
	    echo "  XkbSetPerClientControls found."
	else
	    echo "  XkbSetPerClientControls not found."
	fi
    fi
fi


# done

if [ "$XKB" != "yes" ]
then
    if [ "$VERBOSE" = "yes" ]
    then
	echo "XKB disabled."
    fi
    exit 0
else
    if [ "$VERBOSE" = "yes" ]
    then
	echo "XKB enabled."
    fi
    exit 1
fi
